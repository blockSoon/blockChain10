# ERC 4337 계정의 추상화

# EIP-2771 가스 리스 대납의 내용

- 기존 트랜잭션의 구조를 유지하면서 상위의 트랜잭션의 풀을 하나더 만들었다.

1. ERC4337의 내용을 조금 보고
2. gas paymaster의 내용을 배워볼것. (가스 스테이션 서버)

# 1. user Operations(프론트 페이지에서 보내는 객체(트랜잭션의 형태))

- EIP-2718 === 미래의 거래 유형을 위해서 새로운 트랜잭션 풀의 유형을 정의한다.

- 기존의 트랜잭션을 수정하지 않기위해서.(기존 트랜잭션을 수정하면 안되는 이유. 이전 버전과 호환이 되지 않을수 있기 때문에)

- 새로운 트랜잭션 pool에 요청을 보내면 객체가 쌓인다. 처리 되지않은 객체의 내용

- Dapp의 환경에서 새로운 트랜잭션의 풀에 담기위한 새로운 객체를 만들어서 요청을 보낸다.

- EIP-2718 == 새로운 트랜잭션의 풀에 담아놓고

# 2. Bundlers

- 엔티티의 역활 객체들을 다 가지고와서 서명을 검증하는 암호학을 추가 할수도있고.
- user Operations 객체들을 pool에서 수집해와서 다중의 서명을 검증하고 검증이된 객체의 내용을 수집해서 수집한 객체들을 DTO 데이터를 하나의 트랜잭션의 형태로 변경한다.
- 컨트랙트로 요청을 보낸다 ㅎㅎ 하나의 컨트랙트로 요청하게 된다. 어디? 우리가 작성한 컨트랙트

# 3. Entrypoint

- Bundlers에서 보낸 트랜잭션의 내용을 처리할 컨트랙트.

# ERC4337의 사용 목적

- 사용자의 UX 경험을 좋게 만들자 즉 web3의 지식이 없는 유저도
- 일반 웹페이지 또는 일반 앱을 사용하는 느낌을 받게하면서 web3를 사용할 수 있게 만들어주자.

# 지갑의 추상화

- 계정의 추상화
- 닭 -> 새 -> 동물 -> 생물

- 추상화의 개념은 실제의 것에서 시작 -> 불필요한 요소를 제거한다.

# 계정의 추상화

- EOA, CA 계정 두가지가 있는데.
- EOA, CA 계정 두가지를 모호하게 만들자 추상화 시키자.
- CA 에서 트랜잭션을 발생시키고 싶어
- 계정을 추상화 한다는 것은 CA를 EOA처럼 사용해서 더 복잡한 트랜잭션을 요청 하고싶다.
- 기존의 방식은 EOA계정이 개인키로 서명해서 트랜잭션을 CA에 요청하는 차이.(개인키 유무)
- 계정을 추상화 한다는것은 EOA와 CA 두 계정 모두 트랜잭션을 발생시킬수 있게하자.
- EOA와 CA의 차이를 줄이자.

# 추상화 하려는 이유

- EOA계정을 사용자가 직접 가지고 사용하지 않음.
- CA의 계정을 하나 만들어주고 CA계정으로 요청을 보낼수 있는 로직을 작성
- 다중 서명확인과 임의의 서명확인
- 일정 시간 출금 불가능, 소셜 복구
- 사용자는 클릭 한번으로 web3 생태계에 참여할수 있게 된다.

# 추상 계정의 단점 보안

- 서명의 문제 : EIP-1271의 방식으로 서명을 검증하는데 추상 계정은 다른 방식의 서명을 사용해야겠다.
- 가스비를 연구해서 제안한 내용

# ERC-4337 이전에 제안된 개념

- EIP 이더리움 개선 제안
- EIP 중에서 EIP-86 및 EIP-2938 실현이 불가능했고
- 합의계층을 변경하지 않고 상위 인프라에서 계정을 추상화 하는 접근 방식을 도입했다.

# ERC4337

- 즉 CA의 컨트랙트를 사용자가 계정으로 사용할수 있게 검증 로직을 작성하는 개념
- 이더리움 합의 계층의 변경을 피하고 상위 인프라에서 해결 즉 기존의 이더리움 프로토콜을 추가나 트랜잭션 구조를 변경하지 않고 추상화 시키자.
- userOperation의 객체의 내용을 새로운 트랜잭션 풀에 담고
- 각각의 노드는 Bundlers를 통해 userOperation의 객체들을 조회해서 하나의 트랜잭션으로 컨트랙트 엔트리포인트에 요청을 보낸다.

# 가스비의 대납 paymaster

- 사용자는 web3를 모름...
- 가스비가 뭐지?.
- 웹사이트에서 토큰을 받으면 갯수가 늘어나네? 카운트가 보인다.
- 토큰사용을 해봐야지 상품을 구매하는데 토큰이 10개가 필요하데
- 구매를 눌렀는데 가스비가 없어서 토큰을 지불하고 구매를 할수가 없다. 트랜잭션을 발생시킬수가 없다.
- web3를 모르는 이런 사용자들을 위해 가스비를 대신 내줄게 지불해줄게
- 나중에 요금을 발생시키는것은 우리가 작성할 로직

# 서명

- 서명로직도 우리가 암호학을 작성해서 어러가지의 서명 검증방식을 사용할수 있다.
- 상위 인프라에서 서명을 검증하는 암호학 로직을 더 추가할수 있게 만들자.

```sh
npx create-react-app meta
```

# 메타 트랜잭션

- 실 사용자가 가스비를 내지 않는다. "메타"

# 재밌게 내용을 해볼건데

1. 지갑 10개 가지고
2. 마지막 지갑이 대납의 역활을 할 지갑이 될것.
3. 지갑 10개 중에 ERC20 토큰을 민트하는 내용의 트랜잭션 객체를 보냄
4. 백엔드에 요청 보내고 객체를 트랜잭션 pool에 담아놓고
5. 백엔드 다중 트랜잭션 처리하면서 가스비를 회사의 지갑(마지막 지갑)이 가스비를 지불

# ethers
- web3보다 모던한 느낌의 라이브러리
- web3 보다 사용하기 편하게 만든 라이브러리
```sh
npm i ethers

```

```sh
# (0) 0xe7a5be8380a33a85896c8016b9957a7534f8be2140707dfb6cc8d5752e54cb6a
# (1) 0xed4184d5068668c840860a92584c30a23998d801d0724f836777fe3128fd5c88
# (2) 0x7e8603ca86dc81d745a67d16a4ccc86e55f9b6a686cccac4790f3faa8d3f25c9
# (3) 0x21c805018b9aae3afda564644a6465cccd1f7d671d3dc36fb3ef2832d6a1ee85
# (4) 0x5784ceed85d0f21ffb49270e68adcbd743512cb11675ede5bee26402c504b860
# (5) 0x25101e2332b9799642b43605ee9fb9b6036645722acb71a5ba9bc68ecb02cece
# (6) 0x18a4a3aab21d2863c0f9d8dc57f213d4d7bb26a68332afacf6785bba92186024
# (7) 0x15eb6527fb15169f8fa9ccb62941f867deb1f77df188892f2a9a922c367c7b14
# (8) 0x5de0f633e867194642e01e01f1533521f9ecfcb0344cdc94b6b2d303190c0827
# (9) 0x45e97a7e2101e0ebc35b38a28e905fa99a161de9dc5f8fecd941e2f66a408d6e

npm i -g ganache
npx ganache
```

```sh
remixd -s . --remix-ide https://remix.ethereum.org
```